name: Update Node.js and maintain npm dependencies

on:
  schedule:
    - cron: '30 3 * * 0' # Weekly on Sunday at 3:30 AM UTC (1:30 PM Sydney AEST / 2:30 PM Sydney AEDT) # cspell:words AEST AEDT
  workflow_dispatch: # for manual testing

jobs:
  update-and-maintain:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Get latest Node.js version
        id: get-latest-nodejs-version
        run: |
          LATEST_VERSION=$(curl -s https://nodejs.org/dist/index.json | jq -r '. | sort_by(.version | ltrimstr("v") | split(".") | map(tonumber)) | reverse | .[0].version' | sed 's/^v//') # cspell:words ltrimstr

          # Error handling: check if LATEST_VERSION is non-empty and looks like a version
          if [ -z "$LATEST_VERSION" ] || ! echo "$LATEST_VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Error: Failed to detect latest Node.js version. Got: '$LATEST_VERSION'"
            exit 1
          fi

          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Setup Node.js with latest version
        uses: actions/setup-node@v6
        with:
          node-version: ${{ steps.get-latest-nodejs-version.outputs.latest_version }}
          cache: 'npm'

      - name: Update Node.js version files
        run: |
          echo "${{ steps.get-latest-nodejs-version.outputs.latest_version }}" > .nvmrc
          echo "${{ steps.get-latest-nodejs-version.outputs.latest_version }}" > .node-version
          npm pkg set engines.node="${{ steps.get-latest-nodejs-version.outputs.latest_version }}"

      - name: Update npm engines and maintain dependencies
        run: |
          # Update npm version in package.json
          npm pkg set engines.npm="$(npm --version)"

          # Update package-lock.json
          npm install --package-lock-only --ignore-scripts

          # Dedupe and update dependencies
          npm dedupe
          npm update

      - uses: tibdex/github-app-token@v2 # cspell:words tibdex
        id: generate-token
        with:
          app_id: ${{ secrets.CREATE_PR_APP_ID }}
          private_key: ${{ secrets.CREATE_PR_APP_PRIVATE_KEY }}

      - name: Create PR
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ steps.generate-token.outputs.token }}
          title: 'chore: Node.js and npm maintenance'
          body: 'Automated Node.js and npm maintenance tasks.'
          branch: 'create-pull-request/nodejs-npm-maintenance'
